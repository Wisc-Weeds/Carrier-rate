---
title: "Analysis"
author: "Maxwel Coura Oliveira"
date: "7/9/2020"
output: html_document
---

```{r}
#sarah editing 
```

```{r include = FALSE}
#devtools::install_github("glmmTMB")
```


```{r echo=TRUE, message=FALSE}
library(tidyverse)
library(glmmTMB)
library(lme4)
library(lmerTest)
library(emmeans)
library(car)
library(skimr)
library(pbkrtest)
library(moderndive)
library(purrr)
library(multcomp)
library(broom.mixed)
library(glmmTMB)
```





```{r echo=TRUE, message=FALSE}
dat <- read_csv("control.csv") %>%  # Enter the data
  mutate(control = control/100) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(GPA = as.factor(GPA)) %>% 
  mutate(siteyr = str_c(Location, Year, sep = "-", collapse = NULL)) %>% 
  filter(Herbicide != "Check") %>% 
  mutate(control = ifelse(control == "0", 0.01, control)) 
```




```{r}
skim(dat)
```




# Separate by location

```{r}
library(ggtext)
library(extrafont)
library(ggthemes)
```

10 pl ----- 1 m2
x  pl ----- 1 ft2



```{r}
dat %>% 
  mutate(GPA = as_factor(GPA)) %>% 
  filter(Herbicide != "Check") %>% 
  filter(species %in% c("common ragweed", "giant ragweed", "grass")) %>% 
  group_by(Location, crop, species) %>%
  filter(!is.na(densitym)) %>% 
  summarise(densitym = round(mean(densitym/10.7639),2)) %>% 
  mutate(crop = fct_recode(crop,
                           "Corn" = "corn",
                           "Soybean" = "soybean")) -> density_weed
```


```{r warning = FALSE}
ann_text1 <- data.frame(densitym = 0.2, crop = 1.3, lab = "Text",
                       Location = factor("Arlington", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
ann_text2 <- data.frame(densitym = 0.7, crop = 0.7, lab = "Text",
                       Location = factor("Arlington", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
ann_text3 <- data.frame(densitym = 0.2, crop = 2.3, lab = "Text",
                       Location = factor("Arlington", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
ann_text4 <- data.frame(densitym = 0.7, crop = 1.7, lab = "Text",
                       Location = factor("Arlington", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
ann_text5 <- data.frame(densitym = 0.2, crop = 1.3, lab = "Text",
                       Location = factor("Janesville", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
ann_text6 <- data.frame(densitym = 0.7, crop = 0.7, lab = "Text",
                       Location = factor("Janesville", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
ann_text7 <- data.frame(densitym = 0.2, crop = 2.3, lab = "Text",
                       Location = factor("Janesville", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
ann_text8 <- data.frame(densitym = 0.7, crop = 1.7, lab = "Text",
                       Location = factor("Janesville", levels = c("Arlington", "Janesville")),
                       species = factor("grass", levels = c("common ragweed", 
                                                            "giant ragweed", "grass")))
```

\U1F33D corn

```{r}
labels <- c(
  Corn = "<img src='https://cdn.britannica.com/36/167236-050-BF90337E/Ears-corn.jpg'
    width='100' /><br>Corn",
  Soybean = "<img src='https://cdn.britannica.com/30/174830-050-779DE460/Field-soybeans-farm-Oklahoma.jpg'
    width='100' /><br>Soybean"
)

werle <- "<img src='https://pbs.twimg.com/profile_images/1333481532749729792/E1ppa7uQ_400x400.jpg' width='120'/>"
```


```{r warning = FALSE}
density_weed %>% 
#  mutate(GPA = as_factor(GPA)) %>% 
#  filter(Herbicide != "Check") %>% 
  filter(species %in% c("common ragweed", "giant ragweed", "grass")) %>% 
  mutate(crop = fct_recode(crop,
                           "Corn" = "corn",
                           "Soybean" = "soybean")) %>% 
  ggplot(aes(x=crop, y=densitym, fill=species)) +
  geom_col(stat="identity", position = "fill", width = 0.5) + 
  scale_y_continuous(labels = scales::percent_format(scale=100, suffix ="")) +
  facet_wrap(~Location, ncol=6) + 
#  scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = c("#494949", "#c5050c", "#0479a8")) +
  geom_text(data = ann_text1, label = expression('1.85 grass ft'^2),
            color = "#0479a8") +
  geom_text(data = ann_text2, label = expression('0.07 common ragweed ft'^2),
            color = "#494949") +
  geom_text(data = ann_text3, label = expression('1.76 grass ft'^2),
            color = "#0479a8") +
  geom_text(data = ann_text4, label = expression('0.73 common ragweed ft'^2),
            color = "#494949") +
  geom_text(data = ann_text5, label = expression('0.02 grass ft'^2),
            color = "#0479a8") +
  geom_text(data = ann_text6, label = expression('0.54 giant ragweed ft'^2),
            color = "#c5050c") +
  geom_text(data = ann_text7, label = expression('0.46 grass ft'^2),
            color = "#0479a8") +
  geom_text(data = ann_text8, label = expression('1.29 giant ragweed ft'^2),
            color = "#c5050c") +
  coord_flip() +
  labs(
      fill = "Weed species",
       y = "Weed density (%)",
       x = "") +
  theme_test() +
#  scale_x_discrete(
#    name = NULL,
#    labels = labels
#  ) +
  theme(legend.position = "bottom",
        plot.title = element_markdown(size =14, hjust = 0),
        axis.title = element_markdown(size = 12),
        axis.text.y = element_markdown(size = 11),
        axis.text.x = element_markdown(size = 10),
        text  = element_text(family = "Arial", color = "#282728"),
        strip.background = element_blank(),
        strip.text = element_textbox(
          size = 13, face = "bold", color = "white", fill = "#282728", 
          box.color = "#282728", halign = 0.5, linetype = 1, 
          r = unit(5, "pt"), width = unit(1, "npc"),
          padding = margin(2, 0, 1, 0), 
          margin = margin(3, 3, 3, 3))) +
  ggsave("weeds.png", height = 7, width = 7)
```


```{r warning=FALSE}
dat %>% 
  group_by(crop, Location, Year, Plot, Herbicide, GPA) %>%
  summarise(control = mean(control),
            density= mean(densitym)) %>%
  mutate(GPA = as.factor(GPA)) %>%
  mutate(siteyr = str_c(Location, Year, sep = "-", collapse = NULL)) %>% 
  filter(Herbicide != "Check") %>% 
  
  
ggplot() + aes(x=GPA, y=control*100, color=siteyr) + geom_boxplot() + geom_jitter(alpha=0.2) + coord_flip() +
  facet_wrap(crop ~ Herbicide)
```


# Control (%) analyses


```{r}
cc <- dat %>% 
  filter(crop == "corn" & species == "common ragweed") 


m <- glmmTMB(control ~ Herbicide * factor(GPA) + (1|Plot) + (1|siteyr), beta_family(link = "logit"), data=cc)
glmmTMB:::Anova.glmmTMB(m)
```


```{r}
# Nesting data
nested_data <- dat %>% 
  group_by(crop, species, Location) %>%
  na.omit() %>% 
  filter(species == "common ragweed" | species == "grass" | species == "giant ragweed") %>% 
  nest() %>% 
  arrange(crop, species)
nested_data
```

```{r}
# Fitting linear models
nested_models <- nested_data %>% 
  mutate(model = map(data, ~ glmmTMB(control ~ Herbicide * GPA + (1|Plot), beta_family(link = "logit"), data=.x))) 
nested_models
```



```{r}
# Display estimated parameters, associated statistics, confidence intervals
options(scipen=999)
nested_models %>% 
  mutate(coefs = map(model, glmmTMB:::Anova.glmmTMB)) %>% 
  unnest(coefs) %>% 
  arrange(species) %>% 
  mutate(`Pr(>Chisq)` = round(`Pr(>Chisq)`, 3))
```




```{r}
#nested_models$crop[[2]]
nested_models$model[[4]] %>% 
#  emmip(~ GPA |Herbicide) 
  emmeans(~   Herbicide | GPA, type="response") %>% 
  cld(Letters=letters, adjust="none", reversed = TRUE) %>% 
  as_tibble() -> grass_cn_j
```


```{r}
library(ggtext)
library(gg)
```


```{r}
grass_cn_j %>% 
  mutate(gpa_1 = as.character(GPA)) %>% 
  mutate(gpa_1 = glue::glue("{gpa_1} GPA")) %>% 
  mutate(gpa_1 = fct_relevel(gpa_1, levels = 
                               c("2.5 GPA", "5 GPA",
                                 "10 GPA", "15 GPA",
                                 "17.5 GPA"))) %>% 
  mutate(Herbicide = fct_recode(Herbicide,
                                "bicyclopyrone + mesotrione + *S*-metolachlor" = "Acuron Flexi",
                                "fluthiacet-methyl + pyroxasulfone" = "Anthem Maxx",
                                "acetochlor + clopyralid + mesotrione" = "Resicore"))  %>% 
  ggplot(aes(x = Herbicide, y = response, 
             label = .group, color = Herbicide)) +
  coord_flip() +
  geom_point(size=1) +
  geom_linerange(aes(ymin = lower.CL, ymax = upper.CL),
                 size = 1) +
  facet_grid(~ gpa_1) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "Grass control (%)",
       x = "") +
  geom_text(nudge_y = 0, nudge_x = 0.2) +
  scale_y_continuous(limits = c(0.95, 1), breaks = c(0.96, 0.98, 1),
                     labels = scales::percent_format(scale = 100, 
                                                     accuracy = 1,
                                                     suffix = "")) +
  theme_test() +
  theme(legend.position = "none",
       text  = element_text(family = "Arial", color = "#282728"),
        axis.text.y = element_markdown(),
        strip.background = element_blank(),
        strip.text = element_textbox(face = "bold",
          size = 13, color = "white", fill = "#282728", 
          box.color = "#282728", halign = 0.5, linetype = 1, 
          r = unit(5, "pt"), width = unit(1, "npc"),
          padding = margin(2, 0, 1, 0), 
          margin = margin(3, 3, 3, 3))) +
  ggsave("grass_weeds.png", width = 8, #device = cairo_pdf,
       height = 3)
```






```{r}
# Extracting R squared statistic for each model
nested_models %>% 
  mutate(metrics = map(model, glance)) %>% 
  unnest(metrics) 
```




# Weed Biomass

## Corn

```{r include=FALSE}
biomass <- read_csv("biomass.csv") %>% 
  mutate(GPA = as.factor(GPA))
```

```{r}
biomass <- biomass %>% 
  mutate(biomred = 
     ifelse(crop == "corn" & Location == "Arlington" & Year == "2018", (418.8 - Biomass)/418.8, 
     ifelse(crop == "corn" & Location == "Arlington" & Year == "2019", (30.38115	 - Biomass)/30.38115,
     ifelse(crop == "corn" & Location == "Janesville" & Year == "2018", (539.2 - Biomass)/539.2,
     ifelse(crop == "soybean" & Location == "Arlington" & Year == "2018", (108.8 - Biomass)/108.8, 
     ifelse(crop == "soybean" & Location == "Arlington" & Year == "2019", (101.12	 - Biomass)/101.12,
     ifelse(crop == "soybean" & Location == "Janesville" & Year == "2018", (316.8	 - Biomass)/316.8, NA))))))) %>% 
  mutate(biomred = ifelse(biomred < 0, 0.001, 
                    ifelse(biomred >= 0.99, 0.999, biomred))) %>% 
  filter(Herbicide != "Check") 

```

```{r}
# Nesting data
nested_data <- biomass %>% 
  group_by(crop, Location) %>%
  nest() %>% 
  arrange(crop, Location)
nested_data
```


```{r}
# Fitting linear models
nested_models <- nested_data %>% 
  mutate(model = map(data, ~ glmmTMB(biomred ~ Herbicide * GPA + (1|Plot), beta_family(link = "logit"), data=.x))) 
nested_models
```


```{r}
# Display estimated parameters, associated statistics, confidence intervals
nested_models %>% 
  mutate(coefs = map(model, glmmTMB:::Anova.glmmTMB)) %>% 
  unnest(coefs) 
```


```{r}
#nested_models$crop[[2]]
nested_models$model[[4]] %>% 
#  emmip(~ GPA |Herbicide) 
  emmeans(~ GPA, type="response") %>% 
  cld(Letters=letters, adjust="none", reversed = TRUE)
```
